<!--
 * @Description: 
 * @Author: ddq
 * @Date: 2019-12-19 10:21:06
 * @LastEditors  : ddq
 * @LastEditTime : 2019-12-19 10:22:58
 -->
# 分布式协议之Raft
## 1. leader选举
节点状态有三种状态  
* leader
* candidate
* Follower

初始时每个节点状态都为**follower**，所有节点同时发现没有一个**leader**节点，所以所有节点同时投票给自己，此时并不会出现获得多数投票的节点成为**leader**。第一轮选举失败，各个节点有个**electionTimeout**选举超时时间，时间为150ms到300ms之间随机，各个节点等待选举超时时间过去，自动成为**candidate**状态节点并向其他节点发送新的任期**term**及投票通知，其他节点收到任期，发现任期已经变了，更新自己到任务为最新任期，同时投票选举最新到节点为新的**leader**。

![problem](/分布式协议/resource/选举.jpeg '选举')

## 2. 心跳检测
**leader**节点为了保持自己到统治地位，需定时向**follower**节点发送通知，证明自己还活着，你们别想篡位。如果某个**follower**发现**leader**在**electionTimeout**没有给自己的发送心跳通知，则会变为**candidate**状态，修改任期 **term** + 1，投票给自己并将任期和投票请求发送给其他节点，其他节点接到通知修改任期并发送自己的投票结果

![problem](/分布式协议/resource/心跳检测.jpeg '心跳检测')

## 3. 选举超时
选举失败时，等待**electionTimeout**最小的一个节点重新发起选举
为了尽量避免由于节点数量引起的选举失败，集群内节点部署一般采用奇数：2N + 1

![problem](/分布式协议/resource/选举超时.jpeg '选举超时')

## 4. 日志复制流程
**leader**收到数据变更请求，向写本节点日志，随后将数据变更请求发送给其他**follower**节点，其他节点写日志，写完日志回复消息给**leader**。  
**leader**收到大部分节点回复的写成功消息，提交本地日记，通知客户端变更成功并通知其他**follower**节点提交日志

![problem](/分布式协议/resource/日志复制.jpeg '日志复制')

## 5. 集群中断及恢复
集群中**leader**在没有得到半数以上节点写成功的消息是无法提交日志的。

# **待补充...**



